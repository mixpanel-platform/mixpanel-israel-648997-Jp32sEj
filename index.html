<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/css/reset.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.css">
    <script src="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.js"></script>
    <style>
    .spacer { margin-top: 20px;}    
    h1 { font-size: 20px; color: #747d94;}
    .mylabel {
      float: left;
      font-size: 12px;
      width: 40px;
      height: 31px;
      text-align: center;
      margin-right: 10px;
      color: #747d94;
      font-family: "helvetica neue",helvetica;
      line-height: 32px;
      font-weight: bold;
      margin-bottom: 10px;
    }
    .half { width: 50%; float: left;}
    .hidden { display: none !important; }
    </style>
  </head>
  <body class="mixpanel-platform-body">
    <div class="mixpanel-platform-section">
      <div id="issueSelectLabel" class="mylabel">Issue:</div>
      <div id="issueSelect" style="float: left;"></div>
      <div id="dateSelect" style="float: right;"></div>
      <div style="clear: both;"></div>
    </div>
    <div class="half">
      <div id="table2" class="mixpanel-platform-output-table mixpanel-platform-output" style="visibility: visible;">
        <div class="mixpanel-platform-chart-table">
          <div class="mp_chart_header mp_chart_row">
            <div class="mp_chart_cell mp_chart_row_label" style="width: 72px;">
              <span class="content">Metric</span>
            </div>
            <div class="mp_chart_cell" style="width: 65px;">
              <span class="content">Total</span>
            </div>
          </div>
          <div class="mp_chart_row">
            <div class="mp_chart_row_label mp_chart_cell" style="width: 72px;">
              <span class="content">Page Views</span>
            </div>
            <div class="mp_chart_cell" style="width: 65px;">
              <span id="pageviews"class="content"></span>
            </div>
          </div>
          <div class="mp_chart_row">
            <div class="mp_chart_row_label mp_chart_cell" style="width: 72px;">
              <span class="content">Visitors</span>
            </div>
            <div class="mp_chart_cell" style="width: 65px;">
              <span id="visitors"class="content"></span>
            </div>
          </div>
          <div class="mp_chart_row">
            <div class="mp_chart_row_label mp_chart_cell" style="width: 72px;">
              <span class="content">Unique Visitors</span>
            </div>
            <div class="mp_chart_cell" style="width: 65px;">
              <span id="unique"class="content"></span>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div>
      <div id="table3">
      </div>
    </div>
    <script>
      var params = {
          limit: 1000,                             // maximum number of results to return
          type: 'general',                        // analysis type for the data, can be 'general', 'unique', or 'average'
          unit: 'month',                          // level of granularity of the data, can be 'minute', 'hour', 'day', or 'month'
      };
      var eventTable  = $('#table3').MPTable({
        showPercentages: false,
        firstColHeader: 'Content'
      });
      var startDate = new Date();
      startDate.setDate(startDate.getDate() - 30);
      var endDate = new Date();
      var dateSelect  = $('#dateSelect').MPDatepicker().val({ from: startDate, to: endDate });
      var issueSelect;
      var dateRange;
      var latestIssue = "May/June 2015";
      var selectedIssue = latestIssue;
      var setFilters = function() {
        dateRange = dateSelect.MPDatepicker('value');
        var paramsAll = {
          from: dateRange.from,
          to: dateRange.to,
          limit: 9,                             // maximum number of results to return
          type: 'general',                        // analysis type for the data, can be 'general', 'unique', or 'average'
          unit: 'month'                          
        }; 
        MP.api.segment('page_viewed', 'subtitle', paramsAll).done(function(results) {
          var issues = results.values();
          var issuelist = {};
          issuelist.items = [];
          $.each(issues, function(key, value){
                //console.log("logging", key);
                //$(issuelist).add(key);
                var issueObj = {};
                issueObj.label=key;
                issueObj.value=key;
                //console.log(issueObj);
                issuelist.items.push(issueObj);
                /*for(var i=0; i<key.length; i++){
                  var obj = JSON.parse(key);
                  console.log(obj[i]);
                }
                */
          });
          //console.log("issue list:", issuelist);
          issueSelect = $('#issueSelect').MPSelect(issuelist);
          issueSelect.on('change', function(e, selection) {   
            selectedIssue = selection;
            //console.log("selected issue is", selectedIssue);
            runQuery();
          });
         // for(var i=0; i< issues.childre; i++){
           // delete(i.children[i])
          //  }
        });
      };

      var runQuery = function() {
        var issuefilter = 'properties["subtitle"] == "' + selectedIssue + '"';
        //console.log(issuefilter);
        //console.log ("filtering on this issue:", selectedIssue);
        dateRange = dateSelect.MPDatepicker('value');
        var params = {
          from: dateRange.from,
          to: dateRange.to,
          limit: 9,                             // maximum number of results to return
          type: 'general',                        // analysis type for the data, can be 'general', 'unique', or 'average'
          unit: 'month',                          
          'where': issuefilter
        };
        //console.log(params);
        var paramsUnique = {
          from: dateRange.from,
          to: dateRange.to,
          limit: 10,                             // maximum number of results to return
          type: 'unique',                        // analysis type for the data, can be 'general', 'unique', or 'average'
          unit: 'month',                           // level of granularity of the data, can be 'minute', 'hour', 'day', or 'month'
          'where': issuefilter
        };

       MP.api.segment('page_viewed', params).done(function(results) {
          var mpData = MP.Data.inst(results.values())
          var sumOfData = mpData.sum().values();
          //console.log(mpData);
          $("#pageviews").text(sumOfData.page_viewed);
          $("#table .mixpanel-platform-chart-table .mp_chart_header :nth-child(2) .content").text("Page Views");
        })
        MP.api.segment('visitor', undefined, params).done(function(results) {
          var mpData = MP.Data.inst(results.values())
          var sumOfData = mpData.sum().values();
          $("#visitors").text(sumOfData.visitor);
        })
        MP.api.segment('visitor', undefined, paramsUnique).done(function(results) {
          var mpData = MP.Data.inst(results.values())
          var sumOfData = mpData.sum().values();
          $("#unique").text(sumOfData.visitor);
        })
        MP.api.segment('page_viewed', 'page', params).done(function(results) {
          //eventTable.MPTable('setData', results);
          var mpData = MP.Data.inst(results.values())
          //console.log(mpData);
          var sumOfData = mpData.sum().values();
          console.log("sumOfData=", sumOfData);
          var dataArray = [];
          for (pagenum in sumOfData) {
              var count = sumOfData[pagenum];
              dataArray.push({Page: pagenum, Total: count});
          }
          //console.log(dataArray);

          dataArray.sort(function(a, b){
              if (a.Total < b.Total) return 1;
              if (b.Total < a.Total) return -1;
              return 0;
          });
          console.log("dataArray=", dataArray);

          var sortedPages = {};
          $.each(dataArray, function(key, value){
            //var contentitem = {};

                //contentitem.count=key;
                //contentitem.pagenum=value;
                //console.log(issueObj);
                sortedPages[value.Page]=value.Total;
                console.log("adding", value.Page, "to the object.")
          });
          console.log("sortedPages=", sortedPages);
          eventTable.MPTable('setData', dataArray);
        });
      };

      dateSelect.on('change', runQuery);

      $( document ).ready(function() {
        setFilters();
        runQuery();
        console.log( "ready!" );
        setTimeout(function (){
          $("#table3 .mixpanel-platform-chart-table .mp_chart_header :nth-child(1)").addClass("hidden");
          $("#table3 .mixpanel-platform-chart-table .mp_chart_row :nth-child(1)").addClass("hidden");  
        }, 5000);
      });

    </script>
  </body>
</html>
