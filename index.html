<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">

    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/css/reset.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.css">
    <link href="http://cdn.jsdelivr.net/picnicss/3.4.0/picnic.min.css" rel="stylesheet">

    <script src="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.js"></script>
    <style>
    .spacer { margin-top: 20px;}    
    h1 { font-size: 20px; color: #747d94;}
    h2 { font-size: 16px; color: #747d94; padding: 8px;}
    .mylabel {
      float: left;
      font-size: 12px;
      width: 40px;
      height: 31px;
      text-align: center;
      margin-right: 10px;
      color: #747d94;
      font-family: "helvetica neue",helvetica;
      line-height: 32px;
      font-weight: bold;
      margin-bottom: 10px;
    }
    .hidden { display: none !important; }
    body { box-sizing: content-box; }
    #table2 .mp_chart_row_label { width: 90px; }
    </style>
  </head>
  <body class="mixpanel-platform-body">
    <div class="mixpanel-platform-section">
      <div id="issueSelectLabel" class="mylabel">Issue:</div>
      <div id="issueSelect" style="float: left;"></div>
      <div id="dateSelect" style="float: right;"></div>
      <div style="clear: both;"></div>
    </div>
    <div class="render">
      <div class="row">
        <div>
          <div id="table2" class="mixpanel-platform-output-table mixpanel-platform-output" style="visibility: visible;">
            <h2>Key Issue Metrics</h2>
            <div class="mixpanel-platform-chart-table">
              <div class="mp_chart_header mp_chart_row">
                <div class="mp_chart_cell mp_chart_row_label">
                  <span class="content">Metric</span>
                </div>
                <div class="mp_chart_cell">
                  <span class="content">Total</span>
                </div>
              </div>
              <div class="mp_chart_row">
                <div class="mp_chart_row_label mp_chart_cell">
                  <span class="content">Page Views</span>
                </div>
                <div class="mp_chart_cell">
                  <span id="pageviews"class="content"></span>
                </div>
              </div>
              <div class="mp_chart_row">
                <div class="mp_chart_row_label mp_chart_cell">
                  <span class="content">Sessions</span>
                </div>
                <div class="mp_chart_cell">
                  <span id="visitors"class="content"></span>
                </div>
              </div>
              <div class="mp_chart_row">
                <div class="mp_chart_row_label mp_chart_cell">
                  <span class="content">Unique Visitors</span>
                </div>
                <div class="mp_chart_cell">
                  <span id="unique"class="content"></span>
                </div>
              </div>
              <div class="mp_chart_row">
                <div class="mp_chart_row_label mp_chart_cell">
                  <span class="content">Sessions / Visitor</span>
                </div>
                <div class="mp_chart_cell">
                  <span id="sessVis"class="content"></span>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div>
          <div id="table3" class="mixpanel-platform-output-table mixpanel-platform-output" style="visibility: visible;">
            <h2>Top Content</h2>
            <div id="table3-data" class="mixpanel-platform-chart-table">
            </div>
          </div>
        </div>
      </div>
      <div class="row">
        <div>
          <h2>Page Views by Day</h2>
          <div id="graph"></div>
        </div>
      </div>
    </div>
    <script>
      var params = {
          limit: 100000,                             // maximum number of results to return
          type: 'general',                        // analysis type for the data, can be 'general', 'unique', or 'average'
          unit: 'day',                          // level of granularity of the data, can be 'minute', 'hour', 'day', or 'month'
      };
      var eventTable  = $('#table3').MPTable({
        showPercentages: false,
        firstColHeader: 'Content'
      });
      var startDate = new Date();
      startDate.setDate(startDate.getDate() - 30);
      var endDate = new Date();
      var dateSelect  = $('#dateSelect').MPDatepicker().val({ from: startDate, to: endDate });
      var issueSelect;
      var eventGraph  = $('#graph').MPChart({chartType: 'line'});
      var dateRange;
      var latestIssue = "May/June 2015";
      var selectedIssue = latestIssue;
      var pageviews = 0;
      var sessions = 0;
      var visitors = 0;
      var setFilters = function() {
        dateRange = dateSelect.MPDatepicker('value');
        var paramsAll = {
          from: dateRange.from,
          to: dateRange.to,
          limit: 9,                             // maximum number of results to return
          type: 'general',                        // analysis type for the data, can be 'general', 'unique', or 'average'
          unit: 'month'                          
        }; 
        MP.api.segment('page_viewed', 'subtitle', paramsAll).done(function(results) {
          var issues = results.values();
          var issuelist = {};
          issuelist.items = [];
          $.each(issues, function(key, value){
                //console.log("logging", key);
                //$(issuelist).add(key);
                var issueObj = {};
                issueObj.label=key;
                issueObj.value=key;
                //console.log(issueObj);
                issuelist.items.push(issueObj);
                /*for(var i=0; i<key.length; i++){
                  var obj = JSON.parse(key);
                  console.log(obj[i]);
                }
                */
          });
          //console.log("issue list:", issuelist);
          issueSelect = $('#issueSelect').MPSelect(issuelist);
          issueSelect.on('change', function(e, selection) {   
            selectedIssue = selection;
            //console.log("selected issue is", selectedIssue);
            runQuery();
          });
         // for(var i=0; i< issues.childre; i++){
           // delete(i.children[i])
          //  }
        });
      };

      var runQuery = function() {
        var issuefilter = 'properties["subtitle"] == "' + selectedIssue + '"';
        //console.log(issuefilter);
        //console.log ("filtering on this issue:", selectedIssue);
        dateRange = dateSelect.MPDatepicker('value');
        var params = {
          from: dateRange.from,
          to: dateRange.to,
          limit: 10,                             // maximum number of results to return
          type: 'general',                        // analysis type for the data, can be 'general', 'unique', or 'average'
          unit: 'day',                          
          'where': issuefilter
        };
        //console.log(params);
        var paramsUnique = {
          from: dateRange.from,
          to: dateRange.to,
          limit: 10,                             // maximum number of results to return
          type: 'unique',                        // analysis type for the data, can be 'general', 'unique', or 'average'
          unit: 'month',                           // level of granularity of the data, can be 'minute', 'hour', 'day', or 'month'
          'where': issuefilter
        };

       MP.api.segment('page_viewed', params).done(function(results) {
          var mpData = MP.Data.inst(results.values())
          var sumOfData = mpData.sum().values();
          //console.log(mpData);
          pageviews = sumOfData.page_viewed;
          $("#pageviews").text(pageviews);
          $("#table .mixpanel-platform-chart-table .mp_chart_header :nth-child(2) .content").text("Page Views");
        })
        MP.api.segment('visitor', undefined, params).done(function(results) {
          var mpData = MP.Data.inst(results.values())
          var sumOfData = mpData.sum().values();
          sessions = sumOfData.visitor;
          $("#visitors").text(sessions);
          
          if (visitors != 0) {
            var sessVis = sessions / visitors;
            $("#sessVis").text(sessVis.toFixed(2));
          }

        })
        MP.api.segment('visitor', undefined, paramsUnique).done(function(results) {
          var mpData = MP.Data.inst(results.values())
          var sumOfData = mpData.sum().values();
          visitors = sumOfData.visitor;
          $("#unique").text(visitors);

          if (sessions != 0) {       
            var sessVis = sessions / visitors;
            $("#sessVis").text(sessVis.toFixed(2));
          }

        })
        MP.api.segment('page_viewed', 'page', params).done(function(results) {
          //eventTable.MPTable('setData', results);
          //eventGraph.MPChart('setData', results);
          console.log("results", results);
          var mpData = MP.Data.inst(results.values())
          console.log("mpData", mpData);
          var sumOfData = mpData.sum().values();
          eventGraph.MPChart('setData', results);
          console.log("sumOfData=", sumOfData);
          var dataArray = [];
          for (pagenum in sumOfData) {
              var count = sumOfData[pagenum];
              dataArray.push({Page: pagenum, Total: count});
          }
          //console.log(dataArray);

          dataArray.sort(function(a, b){
              if (a.Total < b.Total) return 1;
              if (b.Total < a.Total) return -1;
              return 0;
          });
          console.log("dataArray=", dataArray);
          var sortedPages = {};
          var table3html = "<div class='mp_chart_header mp_chart_row'><div class='mp_chart_cell mp_chart_row_label'><span class='content'>Page</span></div><div class='mp_chart_cell'><span class='content'>Views</span></div></div>";
          $.each(dataArray, function(key, value){
            
            sortedPages[value.Page]=value.Total;
            //console.log("adding", value.Page, "to the object.")
            table3html += "<div class='mp_chart_row'><div class='mp_chart_cell mp_chart_row_label><span class='content'>" + value.Page + "</span></div><div class='mp_chart_cell'><span class='content'>" + value.Total + "</span></div></div>"
          });
          //console.log("sortedPages=", sortedPages);
          $("#table3-data").html(table3html);
          //eventTable.MPTable('setData', dataArray);
        });

      };

      dateSelect.on('change', runQuery);

      $( document ).ready(function() {
        setFilters();
        runQuery();
        console.log( "ready!" );
        // setTimeout(function (){
        //   $("#table3 .mixpanel-platform-chart-table .mp_chart_header :nth-child(1)").addClass("hidden");
        //   $("#table3 .mixpanel-platform-chart-table .mp_chart_row :nth-child(1)").addClass("hidden");  
        // }, 5000);
      });

    </script>
  </body>
</html>
